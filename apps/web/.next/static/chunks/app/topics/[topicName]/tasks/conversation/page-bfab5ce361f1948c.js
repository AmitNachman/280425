(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[255],{3537:(e,t,r)=>{"use strict";function o(){{let e=localStorage.getItem("token");if(e)return e;for(let e of document.cookie.split(";")){let[t,r]=e.trim().split("=");if("token"===t)return r}}return null}r.d(t,{c4:()=>o}),r(5144),r(4338)},3839:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>g});var o=r(4568),n=r(9731),s=r(7620),a=r(7261),i=r.n(a),c=r(2942),l=r(3537),u=r(9715);AbortSignal.timeout||(AbortSignal.timeout=function(e){let t=new AbortController;return setTimeout(()=>t.abort(new DOMException("TimeoutError","TimeoutError")),e),t.signal});let d={innovation:{phrases:["That's an interesting perspective on technology innovation!","I appreciate your thoughts on tech development.","Your ideas about innovation are quite thought-provoking.","That's a fascinating take on technological advancement!"],questions:["What specific technologies do you think will have the biggest impact in the next decade?","How do you think Israeli innovations have changed everyday life?","Can you think of any technological challenges we still need to solve?","Do you believe AI will fundamentally change how we approach innovation?"],feedback:["Good use of technical vocabulary! Try expanding your answer with more details.","You're expressing your ideas well. Try using more complex sentence structures.","Nice job! Try incorporating more specific examples in your responses.","Well articulated! Consider using more transition words to connect your ideas."]},economy:{phrases:["That's an insightful analysis of economic factors!","Your thoughts on business development are valuable.","I appreciate your perspective on economic growth.","That's a nuanced view of entrepreneurship!"],questions:["What do you think makes Israel's economy unique compared to other countries?","How important do you think startups are to a country's economic growth?","What economic challenges do you think Israel will face in the coming years?","Do you believe digital currency will transform how we think about money?"],feedback:["Good use of economic terminology! Try expanding your ideas with examples.","You're expressing complex ideas well. Consider using more comparative language.","Nice explanation! Try incorporating more financial vocabulary in your responses.","Well structured! Try using more cause-and-effect language in your analysis."]},diplomacy:{phrases:["That's a thoughtful analysis of international relations!","Your perspective on diplomacy is quite interesting.","I appreciate your nuanced view on foreign policy.","That's a compelling point about diplomatic strategies!"],questions:["How do you think Israel's diplomatic relationships have evolved over time?","What role do you think technology plays in modern diplomacy?","Which countries do you think Israel has the strongest relationships with?","How important is cultural exchange in building international relationships?"],feedback:["Good use of diplomatic terminology! Try developing your ideas with specific examples.","You're expressing complex ideas clearly. Consider exploring multiple perspectives.","Nice analysis! Try using more formal language when discussing international relations.","Well articulated! Consider the historical context in your diplomatic analysis."]},default:{phrases:["That's an interesting perspective!","I appreciate your thoughtful response.","You've made some good points there.","That's a fascinating take on the topic!"],questions:["Could you elaborate more on your thoughts about this topic?","What aspects of this subject interest you the most?","How do you think this topic relates to everyday life?","Do you have any personal experiences related to this topic?"],feedback:["Good effort! Try expanding your vocabulary with more topic-specific terms.","You're expressing your ideas well. Try using more complex sentence structures.","Nice job! Try incorporating more specific examples in your responses.","Well done! Consider organizing your thoughts with transition words."]}},h=(e,t,r)=>{let o=Object.keys(d).find(e=>t.toLowerCase().includes(e))||"default",n=d[o],a=n.phrases[Math.floor(Math.random()*n.phrases.length)],i=n.questions[Math.floor(Math.random()*n.questions.length)],c=n.feedback[Math.floor(Math.random()*n.feedback.length)],[l,u]=(0,s.useState)(0),h=e.toLowerCase(),g=a;Date.now(),h.includes("future")||h.includes("next")||h.includes("coming")?g="Your thoughts about future developments are interesting! "+a:h.includes("problem")||h.includes("challenge")||h.includes("difficult")?g="You've highlighted some important challenges. "+a:(h.includes("benefit")||h.includes("advantage")||h.includes("positive"))&&(g="You've noted some significant benefits. "+a);let p=r.filter(e=>h.includes(e.toLowerCase())).map(e=>'Great use of "'.concat(e,'"!')).join(" "),m=p?"".concat(c," ").concat(p):c,f=70;e.length>100&&(f+=10),e.length>200&&(f+=5);let y=r.filter(e=>h.includes(e.toLowerCase())).length;return y>0&&(f+=Math.min(15,5*y)),{text:g,feedback:m,usedWords:r.map(e=>({word:e,used:h.includes(e.toLowerCase()),context:h.includes(e.toLowerCase())?'Found "'.concat(e,'" in your response'):void 0})),nextQuestion:i,score:Math.min(100,f)}};function g(){(0,c.useRouter)();let e=(0,c.useParams)(),t=(0,c.useSearchParams)(),r=null==e?void 0:e.topicName,a=(null==t?void 0:t.get("level"))||"1",d=null==t?void 0:t.get("taskId"),{isAuthenticated:g,isLoading:p,user:m}=(0,u.A)(),[f,y]=(0,s.useState)(!1),[x,w]=(0,s.useState)([]),[v,b]=(0,s.useState)(!0),[k,S]=(0,s.useState)([]),[j,I]=(0,s.useState)(""),[N,T]=(0,s.useState)([]),[E,A]=(0,s.useState)({messagesExchanged:0,correctWords:0,averageScore:0,totalScore:0}),[C,q]=(0,s.useState)(null),[W,L]=(0,s.useState)(!1),[P,O]=(0,s.useState)(!1),[R,M]=(0,s.useState)(!1),[D,U]=(0,s.useState)(!1),[Y,z]=(0,s.useState)([]),[_,F]=(0,s.useState)(null),[J,Q]=(0,s.useState)(null),[B,H]=(0,s.useState)(0),V=(0,s.useRef)(null),G=(0,s.useRef)(null),$=(0,s.useRef)(null),K=(0,s.useRef)(null),X=(0,s.useRef)(null),Z=(0,s.useRef)(null),ee=(0,s.useRef)(null),et=(0,s.useRef)(null),er=(0,s.useRef)(null),[eo,en]=(0,s.useState)([]),[es,ea]=(0,s.useState)("");(0,s.useEffect)(()=>{(async()=>{if(g)if(!d&&r&&a)try{let e=(0,l.c4)();if(!e)throw Error("Authentication required");let t=sessionStorage.getItem("post_task_".concat(r,"_").concat(a));console.log("Creating new conversation task, previous task ID:",t);let o=await fetch("/api/tasks",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({TopicName:r,Level:a,TaskType:"conversation"})});if(!o.ok)throw Error("Failed to create conversation task");let n=await o.json();if(console.log("Created conversation task:",n),n.TaskId){let e=new URL(window.location.href);e.searchParams.set("taskId",n.TaskId),window.history.replaceState({},"",e.toString()),sessionStorage.setItem("task_start_".concat(n.TaskId),Date.now().toString())}}catch(e){console.error("Error creating conversation task:",e),q("Failed to initialize conversation task")}else d&&sessionStorage.setItem("task_start_".concat(d),Date.now().toString())})()},[g,d,r,a]),(0,s.useEffect)(()=>{try{let e=window.SpeechRecognition||window.webkitSpeechRecognition;e&&(V.current=new e,V.current.continuous=!1,V.current.interimResults=!0,V.current.lang="en-US",V.current.onresult=e=>{let t=e.results[e.results.length-1];if(t.isFinal){let e=t[0].transcript.trim();if(e.length>1){var r;let t=(null==(r=x.find(e=>"ai"===e.type))?void 0:r.content)||"";if(function(e,t){let r=e.toLowerCase().replace(/[^\w\s]/g,""),o=t.toLowerCase().replace(/[^\w\s]/g,""),n=r.split(/\s+/).filter(e=>e.length>2),s=o.split(/\s+/).filter(e=>e.length>2);if(0===n.length||0===s.length)return 0;let a=0,i=Math.min(n.length,s.length),c=Math.min(6,i),l=0;for(let e=0;e<c;e++)e<n.length&&e<s.length&&n[e]===s[e]&&l++;if(l>=3||c>0&&l/c>=.5)return .9;for(let e of n)s.includes(e)&&e.length>3&&a++;return a/Math.max(n.length,1)}(e,t)>.7)return void console.log("Detected echo of AI's own speech, ignoring");console.log("Final transcript:",e),eu(e)}}},V.current.onstart=()=>{console.log("Recognition started"),M(!1)},V.current.onspeechstart=()=>{console.log("Speech detected"),M(!0);let e=0,t=setInterval(()=>{++e>5&&clearInterval(t)},100);X.current&&(clearTimeout(X.current),X.current=null)},V.current.onspeechend=()=>{console.log("Speech ended"),X.current=window.setTimeout(()=>{M(!1);try{V.current.stop()}catch(e){console.log("Error stopping recognition",e)}},1e3)},V.current.onend=()=>{if(console.log("Recognition ended"),D&&!R){console.log("Restarting recognition");try{V.current.start()}catch(e){console.log("Error restarting recognition",e),setTimeout(()=>{if(D)try{V.current.start()}catch(e){console.log("Failed to restart recognition again",e)}},500)}}},V.current.onerror=e=>{if(console.error("Recognition error:",e.error),"no-speech"===e.error&&D)try{V.current.stop(),setTimeout(()=>{if(D)try{V.current.start(),w(e=>e.some(e=>"ai"===e.type&&e.content.includes("waiting for your response"))?e:[...e,{type:"ai",content:"I'm waiting for your response. Please speak clearly when the microphone is active.",feedback:"Microphone is listening"}])}catch(e){console.log("Error restarting after no-speech",e)}},300)}catch(e){console.log("Error handling no-speech",e)}}),G.current=window.speechSynthesis}catch(e){console.error("Error initializing speech APIs:",e),q("Speech recognition not available in your browser")}return()=>{if(V.current)try{V.current.stop()}catch(e){console.log("Error stopping recognition on cleanup",e)}G.current&&G.current.cancel(),[K.current,X.current,er.current].forEach(e=>{e&&clearTimeout(e)})}},[]),(0,s.useEffect)(()=>{var e;null==(e=$.current)||e.scrollIntoView({behavior:"smooth"})},[x]),(0,s.useEffect)(()=>{if(Y.length>0&&!P&&f){let e=Y[0];z(e=>e.slice(1)),ed(e,()=>{Y.length<=1&&f&&setTimeout(()=>{U(!0),el()},500)})}},[Y,P,f]),(0,s.useEffect)(()=>{(async()=>{if(g&&r)try{b(!0),q(null);let e=(0,l.c4)();if(!e)throw Error("Authentication required");try{let t=await fetch("/api/create-post/".concat(encodeURIComponent(r)),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({})});if(t.ok){let e=await t.json();e.text&&I(e.text),e.requiredWords&&Array.isArray(e.requiredWords)&&T(e.requiredWords)}}catch(e){console.error("Error loading post content:",e)}try{let t=await fetch("/api/words/learned?topic=".concat(encodeURIComponent(r)),{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();console.log("Learned words response:",e),e.success&&Array.isArray(e.data)?(S(e.data.map(e=>e.Word)),console.log("Loaded ".concat(e.data.length," learned words from ").concat(e.source||"API"))):Array.isArray(e)?(S(e.map(e=>e.Word)),console.log("Loaded ".concat(e.length," learned words (legacy format)"))):(console.warn("Received empty or invalid learned words response:",e),S([]))}else{console.error("Failed to fetch learned words:",t.status,t.statusText);try{let e=await t.text();console.error("Error details:",e)}catch(e){console.error("Could not parse error response")}}}catch(e){console.error("Error loading learned words:",e)}}catch(e){console.error("Error loading initial data:",e),q(e instanceof Error?e.message:"Failed to load data")}finally{b(!1)}})()},[g,r]);let ei=e=>e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "),ec=e=>{if(!e)return"";let t=e;return N.forEach(e=>{if(!e)return;let r=RegExp("\\b".concat(e,"\\b"),"gi");t=t.replace(r,'<span class="font-bold text-orange-600">$&</span>')}),t},el=()=>{if(V.current)try{console.log("Activating microphone"),V.current.start(),w(e=>{let t=e[e.length-1];return t&&"ai"===t.type&&t.content.includes("Microphone is active")?e:[...e,{type:"ai",content:"\uD83C\uDFA4 Microphone is active. Please speak now.",feedback:"Your turn to speak"}]}),K.current&&clearTimeout(K.current),K.current=window.setTimeout(()=>{if(D&&!R){try{var e;null==(e=V.current)||e.stop(),U(!1)}catch(e){console.log("Error stopping recognition on timeout",e)}let t="I didn't hear your response. Let's move on to the next question.";w(e=>[...e,{type:"ai",content:t}]),z(e=>[...e,t,"Let's try again. "+ep()])}},2e4)}catch(e){console.error("Could not start speech recognition:",e),w(e=>[...e,{type:"ai",content:"I'm having trouble with the microphone. Please try refreshing the page.",feedback:"Microphone error"}])}},eu=async e=>{U(!1),M(!1),er.current&&clearTimeout(er.current),er.current=window.setTimeout(()=>{if(D&&f){let e="Are you still there? I'm waiting for your response.";w(t=>[...t,{type:"ai",content:e}]),z(t=>[...t,e])}},3e4);try{V.current&&V.current.stop()}catch(e){console.log("Error stopping recognition after response",e)}w(t=>[...t,{type:"user",content:e}]);try{w(e=>[...e,{type:"ai",content:"...",feedback:"Analyzing your response..."}]);let t=await eh(e),r="".concat(t.text,"\n\n").concat(t.nextQuestion);w(e=>{let o=[...e],n=o.findIndex(e=>"ai"===e.type&&"..."===e.content&&"Analyzing your response..."===e.feedback);return -1!==n&&o.splice(n,1),[...o,{type:"ai",content:r,feedback:t.feedback,score:t.score}]}),z(e=>e.some(e=>e.includes(t.text.substring(0,20)))?e:[...e,r]),J&&await eb(J,e,JSON.stringify({feedback:t.feedback,score:t.score,usedWords:t.usedWords})),ev(t.nextQuestion),A(e=>{let r=e.totalScore+t.score,o=e.messagesExchanged+1;return{messagesExchanged:o,correctWords:e.correctWords+t.usedWords.filter(e=>e.used).length,totalScore:r,averageScore:Math.round(r/o)}}),!(E.messagesExchanged>=3)||x.some(e=>e.content.includes("complete this exercise"))||Y.some(e=>e.includes("complete this exercise"))||setTimeout(()=>{let e="You're doing great! Would you like to continue practicing or complete this exercise?";w(t=>[...t,{type:"ai",content:e,feedback:'You can say "complete" to finish or continue responding to practice more.'}]),ev(e),z(t=>[...t,e])},7e3)}catch(e){console.error("Error processing response:",e),w(e=>{let t=[...e],r=t.findIndex(e=>"ai"===e.type&&"..."===e.content&&"Analyzing your response..."===e.feedback);-1!==r&&t.splice(r,1);let o="I'm having trouble understanding. Let's try again.";return z(e=>[...e,o]),[...t,{type:"ai",content:o,feedback:"Technical issue occurred. Please try responding again."}]})}},ed=(e,t)=>{if(!G.current)return;if(P&&Z.current){console.log("Already speaking, not starting new utterance"),t&&setTimeout(t,500);return}if(O(!0),G.current.cancel(),V.current)try{V.current.stop()}catch(e){console.log("Error stopping recognition during AI speech",e)}et.current=Date.now();let r=Date.now().toString();console.log("Starting speech ID: ".concat(r," with text length: ").concat(e.length));let o=((e=>{let t=e.match(/[^\.!\?]+[\.!\?]+|\s*$/g)||[],r=[],o=new Set;return t.forEach(e=>{let t=e.trim();if(t.length>0){let e=t.toLowerCase().replace(/\s+/g," ");o.has(e)||(o.add(e),r.push(t))}}),r.join(" ")})(e).match(/[^\.!\?]+[\.!\?]+|\s*$/g)||[]).filter(e=>e.trim().length>0);if(0===o.length){console.log("No speech chunks to process"),O(!1),t&&setTimeout(t,100);return}let n=0,s=()=>{var e;if(n>=o.length){console.log("Speech ID: ".concat(r," completed")),O(!1),Z.current=null,t&&setTimeout(t,300);return}let a=new SpeechSynthesisUtterance(o[n]),i=(null==(e=G.current)?void 0:e.getVoices())||[],c=i.find(e=>e.name===es)||i.find(e=>"en-US"===e.lang);c&&(a.voice=c,console.log("Using voice: ".concat(c.name))),a.lang="en-US",a.rate=1,a.pitch=1.1,a.onend=()=>{n++,s()},a.onerror=e=>{console.error("Speech error in chunk ".concat(n,":"),e),n++,s()},Z.current=a,G.current&&G.current.speak(a)};s();let a=setTimeout(()=>{P&&(console.log("Speech watchdog triggered for speech ID: ".concat(r)),O(!1),G.current&&G.current.cancel(),t&&t())},3e4);return()=>clearTimeout(a)},eh=async e=>{try{let t=(0,l.c4)();if(!t)throw Error("Authentication required");let o=await fetch("/api/analyze-conversation",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({text:e,topic:r,formattedTopic:ei(r),level:"intermediate",learnedWords:k,requiredWords:N,postContent:j,previousMessages:x.map(e=>({role:"user"===e.type?"user":"assistant",content:e.content}))})});if(429===o.status)return console.warn("Rate limit reached, using fallback response"),h(e,r,N);if(!o.ok){let t=await o.json().catch(()=>({}));return console.error("API response error:",o.status,t),h(e,r,N)}try{let t=await o.json();if(!t.text||!t.feedback||!t.nextQuestion)return console.error("Invalid API response format:",t),h(e,r,N);return t}catch(t){return console.error("Error parsing API response:",t),h(e,r,N)}}catch(t){return console.error("API request error:",t),h(e,r,N)}},eg=async()=>{y(!0),w([]),O(!1),M(!1),U(!1),z([]),A({messagesExchanged:0,correctWords:0,averageScore:0,totalScore:0});try{let e=await ew();if(!e){q("Failed to create conversation session"),y(!1);return}F(e),console.log("Setting sessionId state to: ".concat(e));let t="Welcome to our conversation about ".concat(ei(r),"! Let's practice English together.");w([{type:"ai",content:t}]);let o=ep();z([t,o]);let s=async()=>{try{if(!e)return console.error("Cannot record first question: sessionId not available"),null;console.log("Recording first question using direct sessionId: ".concat(e));let t=async(e,t)=>{if(!t)return console.error("Cannot record question: missing sessionId parameter"),null;let r=(0,n.A)();Q(r),H(e=>e+1);try{let o=(0,l.c4)();if(!o)return console.warn("No authentication token available for question recording"),r;let n=e.length>1e3?e.substring(0,997)+"...":e;console.log("Recording question for session ".concat(t,":"),n.substring(0,30)+"...");try{let e=await fetch("/api/question",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({QuestionId:r,SessionId:t,QuestionText:n}),signal:AbortSignal.timeout(8e3)});if(!e.ok){let t="Failed to record question";try{t=(await e.json()).error||t}catch(r){t=await e.text()||t}return console.error("Question recording failed: ".concat(t)),r}let s=await e.json();return console.log("Question recorded successfully:",s),r}catch(e){return console.error("Error recording question:",e),r}}catch(e){return console.error("Error in recordQuestion:",e),r}},r=await t(o,e);console.log("Recorded first question with ID:",r),w(e=>[...e,{type:"ai",content:o}])}catch(e){console.error("Error recording first question:",e),w(e=>[...e,{type:"ai",content:o}])}};setTimeout(s,500)}catch(e){console.error("Error in startConversation:",e),q("Failed to start conversation. Please try again."),y(!1)}},ep=()=>{let e=r.toLowerCase();if(e.includes("diplomacy"))return"What do you think about Israel's diplomatic relations with other countries?";if(e.includes("economy"))return"What interests you about Israel's economy or startup ecosystem?";if(e.includes("innovation"))return"What Israeli technological innovations are you familiar with?";if(e.includes("history"))return"What aspects of Israeli history do you find most interesting?";if(e.includes("holocaust"))return"Why do you think it's important to remember historical events like the Holocaust?";else if(e.includes("iron")||e.includes("sword"))return"What are your thoughts on how countries should protect their citizens?";else if(e.includes("environment"))return"What do you think about Israel's focus on renewable energy to protect the environment?";else if(e.includes("society"))return"What do you think is the most important action individuals can take to help protect the environment?";else return"What aspects of ".concat(ei(r)," interest you the most?")},em=()=>{if(U(!1),V.current)try{V.current.stop()}catch(e){console.log("Error stopping recognition",e)}G.current&&G.current.cancel(),O(!1),K.current&&(clearTimeout(K.current),K.current=null),X.current&&(clearTimeout(X.current),X.current=null)},ef=async()=>{y(!1),U(!1),w(e=>[...e,{type:"ai",content:"Saving your progress...",feedback:"Please wait while we update your level."}]);try{em();let e=E.totalScore;if(e<=0&&E.messagesExchanged>0&&(e=Math.round(E.correctWords/E.messagesExchanged*100)),e=Math.max(60,e),await ey(),d){let t=sessionStorage.getItem("task_start_".concat(d)),r=0;t&&(r=Math.floor((Date.now()-parseInt(t))/1e3));let o=(0,l.c4)();o&&await fetch("/api/tasks",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({taskId:d,TaskScore:e,DurationTask:r,CompletionDate:new Date().toISOString(),SessionId:_,QuestionsCount:B,MessagesExchanged:E.messagesExchanged})})}window.location.href="/topics"}catch(e){console.error("Error in stopConversation:",e)}},ey=async()=>{if(!d||!r||!a)throw console.error("Missing required information to update user level"),Error("Missing required data");let e=(0,l.c4)();if(!e)throw Error("Authentication required");let t=E.totalScore;t<=0&&E.messagesExchanged>0&&(t=Math.round(E.correctWords/E.messagesExchanged*100)),t=Math.max(t,60);let o=r.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "),n=await fetch("/api/user-level/update",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({topicName:o,currentLevel:parseInt(a),earnedScore:t,taskId:d,isCompleted:!0})});return{...JSON.parse(await n.text()),success:!0}},ex=async()=>{if(!W&&d)try{L(!0),em();let e=(0,l.c4)();if(!e)throw Error("Authentication required");let t="Great job! You've completed the conversation practice.",o="Your average score: ".concat(E.averageScore,"/100");w(e=>[...e,{type:"ai",content:t,feedback:o}]),_&&await ev(t),ed(t+" "+o,()=>{setTimeout(()=>{console.log("Redirecting to topics page..."),window.location.href="/topics"},2e3)});let n=sessionStorage.getItem("task_start_".concat(d)),s=0;n&&(s=Math.floor((Date.now()-parseInt(n))/1e3)),console.log("Marking task ".concat(d," as completed with score ").concat(E.averageScore," and duration ").concat(s,"s"));try{let t=await fetch("/api/tasks",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({taskId:d,TaskScore:E.averageScore||60,DurationTask:s,CompletionDate:new Date().toISOString(),SessionId:_,QuestionsCount:B,MessagesExchanged:E.messagesExchanged})});if(t.ok){let e=await t.json();console.log("Task completion result:",e)}else console.error("Failed to complete task: ".concat(await t.text()))}catch(e){console.error("Error completing task:",e)}try{console.log("Updating user level...");let t=r.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "),o=await fetch("/api/user-level/update",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({topicName:t,currentLevel:parseInt(a||"1"),earnedScore:E.averageScore||60,taskId:d,isCompleted:!0})});if(!o.ok){let e=await o.text();throw console.error("Level update failed: ".concat(e)),Error("Failed to update user level")}let n=await o.json();console.log("User level update result:",n)}catch(e){console.error("Error updating user level:",e)}let i="Task completed! You can now return to topics or try another activity.";w(e=>[...e,{type:"ai",content:i,feedback:"✅ Task completion recorded"}]),ed(i,()=>{setTimeout(()=>{console.log("Redirecting to topics page..."),window.location.href="/topics"},2e3)})}catch(t){console.error("Error completing task:",t);let e="There was an issue saving your progress. Please try again.";w(t=>[...t,{type:"ai",content:e,feedback:"Error completing task"}]),ed(e,()=>{})}finally{L(!1)}},ew=async()=>{if(!d)return console.error("Cannot create session: missing taskId"),null;let e=(0,n.A)();ee.current=e,F(e);try{let t=(0,l.c4)();if(!t)return console.warn("No authentication token available for session creation"),e;console.log("Creating interactive session for task ".concat(d));try{let r=await fetch("/api/interactive-session",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({SessionId:e,taskId:d,sessionType:"conversation"}),signal:AbortSignal.timeout(8e3)});if(!r.ok){let t="Failed to create interactive session";try{t=(await r.json()).error||t}catch(e){t=await r.text()||t}return console.error("Interactive session creation failed: ".concat(t)),e}let o=await r.json();if(console.log("Interactive session created:",o),o.SessionId&&o.SessionId!==e)return ee.current=o.SessionId,F(o.SessionId),o.SessionId;return e}catch(t){return console.error("Error creating interactive session:",t),e}}catch(t){return console.error("Error in createInteractiveSession:",t),e}},ev=async e=>{let t=ee.current||_;if(!t)return console.error("Cannot record question: missing sessionId (checked both ref and state)"),null;let r=(0,n.A)();Q(r),H(e=>e+1);try{let o=(0,l.c4)();if(!o)return console.warn("No authentication token available for question recording"),r;let n=e.length>1e3?e.substring(0,997)+"...":e;console.log("Recording question for session ".concat(t,":"),n.substring(0,30)+"...");try{let e=await fetch("/api/question",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({QuestionId:r,SessionId:t,QuestionText:n}),signal:AbortSignal.timeout(8e3)});if(!e.ok){let t="Failed to record question";try{t=(await e.json()).error||t}catch(r){t=await e.text()||t}return console.error("Question recording failed: ".concat(t)),r}let s=await e.json();return console.log("Question recorded successfully:",s),r}catch(e){return console.error("Error recording question:",e),r}}catch(e){return console.error("Error in recordQuestion:",e),r}},eb=async(e,t,r)=>{let o=ee.current||_;if(!o||!e)return console.error("Cannot record answer: missing sessionId or questionId"),!1;try{let n=(0,l.c4)();if(!n)return console.warn("No authentication token available for answer recording"),!1;let s=t.length>1e3?t.substring(0,997)+"...":t,a=r;if("string"!=typeof r)try{a=JSON.stringify(r)}catch(e){console.warn("Error stringifying feedback, using empty string:",e),a=""}console.log("Recording answer for question ".concat(e," in session ").concat(o));try{let t=await fetch("/api/question/".concat(e),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n)},body:JSON.stringify({AnswerText:s,Feedback:a}),signal:AbortSignal.timeout(8e3)});if(!t.ok){let e="Failed to record answer";try{e=(await t.json()).error||e}catch(r){e=await t.text()||e}return console.error("Answer recording failed: ".concat(e)),!1}let r=await t.json();return console.log("Answer recorded successfully:",r),!0}catch(e){return console.error("Error recording answer:",e),!1}}catch(e){return console.error("Error in recordAnswer:",e),!1}};return((0,s.useEffect)(()=>{if(window.speechSynthesis){let e=()=>{let e=window.speechSynthesis.getVoices();if(e.length>0){let t=e.filter(e=>e.lang.includes("en-"));en(t);let r=t.find(e=>e.name.includes("Female")||e.name.includes("female"));r?ea(r.name):t.length>0&&ea(t[0].name)}};void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=e),e()}},[]),p||v)?(0,o.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-yellow-50 via-orange-50 to-red-50 p-6 flex justify-center items-center",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"inline-block w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-4"}),(0,o.jsx)("p",{className:"text-xl font-medium text-gray-700",children:"Loading conversation..."})]})}):C?(0,o.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-yellow-50 via-orange-50 to-red-50 p-6 flex justify-center items-center",children:(0,o.jsxs)("div",{className:"max-w-md w-full bg-white p-8 rounded-2xl shadow-xl text-center",children:[(0,o.jsx)("div",{className:"text-red-500 text-5xl mb-4",children:"❌"}),(0,o.jsx)("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:C}),(0,o.jsx)("p",{className:"text-gray-600 mb-6",children:"We couldn't load the conversation at this time. Please try again later."}),(0,o.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,o.jsx)("button",{onClick:()=>window.location.reload(),className:"px-6 py-3 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition-all duration-300",children:"Try Again"}),(0,o.jsx)(i(),{href:"#",className:"px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all duration-300",children:"Back to Topics"})]})]})}):(0,o.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-yellow-50 via-orange-50 to-red-50 p-6 relative",children:[(0,o.jsxs)("h1",{className:"text-3xl font-bold text-center text-gray-800 mb-6 mt-2",children:[ei(r)," - Conversation Practice"]}),(0,o.jsxs)("div",{className:"max-w-4xl mx-auto mt-4",children:[!f&&(0,o.jsxs)("div",{className:"bg-white rounded-2xl shadow-xl p-8 mb-8 text-center",children:[(0,o.jsx)("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:"Conversation Practice"}),(0,o.jsxs)("p",{className:"text-gray-600 mb-6",children:["Practice speaking English about ",(0,o.jsx)("span",{className:"font-bold",children:ei(r)}),". Our AI conversation partner will listen to you, provide feedback, and help you improve your speaking skills."]}),N.length>0&&(0,o.jsxs)("div",{className:"mb-6",children:[(0,o.jsx)("h3",{className:"text-xl font-semibold text-gray-700 mb-3",children:"Try to use these words:"}),(0,o.jsx)("div",{className:"flex flex-wrap gap-2 justify-center",children:N.map((e,t)=>(0,o.jsx)("span",{className:"px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm",children:e},t))})]}),(0,o.jsx)("button",{onClick:eg,className:"px-8 py-4 bg-orange-500 text-white text-xl font-bold rounded-full hover:bg-orange-600 transition-colors shadow-lg",children:"Start Conversation"})]}),f&&(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,o.jsx)("button",{onClick:ef,className:"px-6 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors shadow-lg",children:"End Conversation"}),E.messagesExchanged>=3&&(0,o.jsx)("button",{onClick:ex,disabled:W,className:"px-6 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors shadow-lg disabled:opacity-50",children:W?"Completing...":"Complete Task"})]}),(0,o.jsxs)("div",{className:"bg-white rounded-2xl shadow-xl p-6 mb-4",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsx)("div",{className:"w-12 h-12 rounded-full flex items-center justify-center text-xl ".concat(P?"bg-green-100 animate-pulse":D?"bg-red-100 animate-pulse":"bg-orange-100"),children:P?"\uD83D\uDD0A":D?"\uD83C\uDF99️":"\uD83D\uDCAC"}),(0,o.jsxs)("div",{className:"ml-4",children:[(0,o.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:"AI Conversation Partner"}),(0,o.jsx)("p",{className:"text-gray-500 text-sm",children:P?"AI is speaking... Please listen":D?"Your turn to speak - Microphone active":f?"Processing...":"Click Start to begin"})]})]}),E.messagesExchanged>0&&(0,o.jsxs)("div",{className:"bg-gray-100 px-4 py-2 rounded-lg",children:[(0,o.jsx)("div",{className:"text-sm text-gray-500",children:"Your score"}),(0,o.jsxs)("div",{className:"text-2xl font-bold text-orange-600",children:[E.averageScore,"/100"]})]})]}),(0,o.jsxs)("div",{className:"space-y-4 max-h-[400px] overflow-y-auto mb-4",children:[x.map((e,t)=>(0,o.jsxs)("div",{className:"p-4 rounded-lg ".concat("user"===e.type?"bg-orange-100 ml-12":e.content.includes("Microphone is active")?"bg-red-50 border border-red-200":"bg-gray-100 mr-12"),children:["ai"===e.type&&e.content.includes("Microphone is active")?(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsx)("div",{className:"w-6 h-6 bg-red-500 rounded-full animate-pulse mr-2"}),(0,o.jsx)("p",{className:"text-gray-800 font-medium",children:e.content})]}):(0,o.jsx)("p",{className:"text-gray-800",dangerouslySetInnerHTML:{__html:"ai"===e.type?ec(e.content):e.content}}),e.feedback&&(0,o.jsx)("p",{className:"mt-2 text-sm text-orange-600 italic",children:e.feedback}),void 0!==e.score&&(0,o.jsxs)("div",{className:"mt-2 flex items-center",children:[(0,o.jsx)("span",{className:"text-sm text-gray-500 mr-2",children:"Score:"}),(0,o.jsxs)("span",{className:"text-sm font-medium ".concat(e.score>=80?"text-green-600":e.score>=60?"text-orange-600":"text-red-600"),children:[e.score,"/100"]})]})]},t)),(0,o.jsx)("div",{ref:$})]}),(0,o.jsxs)("div",{className:"mt-4 bg-gray-50 p-3 rounded-lg border border-gray-200",children:[(0,o.jsx)("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"Conversation Status:"}),(0,o.jsxs)("div",{className:"flex flex-wrap items-center gap-4 justify-between",children:[(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsx)("div",{className:"w-3 h-3 rounded-full mr-2 ".concat(P?"bg-green-500 animate-pulse":"bg-gray-300")}),(0,o.jsx)("span",{className:"text-sm text-gray-600",children:"AI Speaking"})]}),(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsx)("div",{className:"w-3 h-3 rounded-full mr-2 ".concat(D?"bg-red-500 animate-pulse":"bg-gray-300")}),(0,o.jsx)("span",{className:"text-sm text-gray-600",children:"Your Turn to Speak"})]}),(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsx)("div",{className:"w-3 h-3 rounded-full mr-2 ".concat(R?"bg-orange-500 animate-pulse":"bg-gray-300")}),(0,o.jsx)("span",{className:"text-sm text-gray-600",children:"Speech Detected"})]})]})]}),P&&(0,o.jsx)("div",{className:"mt-4 flex justify-center",children:(0,o.jsx)("button",{onClick:()=>{G.current&&G.current.cancel(),O(!1),Z.current=null,w(e=>[...e,{type:"ai",content:"Speech skipped. Your turn to speak.",feedback:"Manual skip"}]),setTimeout(()=>{U(!0),el()},500)},className:"px-4 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition-colors shadow-md",children:"Skip AI Speech"})}),f&&(0,o.jsxs)("div",{className:"mt-4 bg-gray-50 p-3 rounded-lg border border-gray-200",children:[(0,o.jsx)("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"Voice Settings:"}),(0,o.jsxs)("div",{className:"flex items-center",children:[(0,o.jsx)("span",{className:"text-sm text-gray-600 mr-2",children:"Voice:"}),(0,o.jsx)("select",{value:es,onChange:e=>ea(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:eo.map(e=>(0,o.jsx)("option",{value:e.name,children:e.name},e.name))})]})]})]}),N.length>0&&(0,o.jsxs)("div",{className:"bg-white rounded-2xl shadow-xl p-6",children:[(0,o.jsx)("h3",{className:"text-lg font-semibold text-gray-700 mb-3",children:"Try to use these words:"}),(0,o.jsx)("div",{className:"flex flex-wrap gap-2",children:N.map((e,t)=>(0,o.jsx)("span",{className:"px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm",children:e},t))})]})]})]})]})}},4876:(e,t,r)=>{Promise.resolve().then(r.bind(r,3839))},9715:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var o=r(7620);let n=()=>{let[e,t]=(0,o.useState)({isAuthenticated:!1,isLoading:!0,user:null,error:null});(0,o.useEffect)(()=>{(async()=>{let e=localStorage.getItem("token");if(!e)return t({isAuthenticated:!1,isLoading:!1,user:null,error:null});try{let r=await fetch("/api/auth/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})}),o=await r.json();if(o.success){let e=o.user;if(!e){let t=localStorage.getItem("user");t&&(e=JSON.parse(t))}t({isAuthenticated:!0,isLoading:!1,user:e,error:null})}else localStorage.removeItem("token"),localStorage.removeItem("user"),t({isAuthenticated:!1,isLoading:!1,user:null,error:o.message||"Authentication failed"})}catch(e){console.error("Auth validation error:",e),t({isAuthenticated:!1,isLoading:!1,user:null,error:e instanceof Error?e.message:"Authentication error"})}})()},[]);let r=async(e,r)=>{try{t(e=>({...e,isLoading:!0}));let o=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:r})}),n=await o.json();if(n.success)return localStorage.setItem("token",n.token),localStorage.setItem("user",JSON.stringify(n.user)),t({isAuthenticated:!0,isLoading:!1,user:n.user,error:null}),{success:!0};return t({isAuthenticated:!1,isLoading:!1,user:null,error:n.message||"Login failed"}),{success:!1,message:n.message||"Login failed"}}catch(r){let e=r instanceof Error?r.message:"An unexpected error occurred";return t({isAuthenticated:!1,isLoading:!1,user:null,error:e}),{success:!1,message:e}}};return{...e,login:r,logout:()=>{localStorage.removeItem("token"),localStorage.removeItem("user"),t({isAuthenticated:!1,isLoading:!1,user:null,error:null})}}}},9731:(e,t,r)=>{"use strict";let o;r.d(t,{A:()=>i});let n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},s=new Uint8Array(16),a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));let i=function(e,t,r){if(n.randomUUID&&!t&&!e)return n.randomUUID();let i=(e=e||{}).random??e.rng?.()??function(){if(!o){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");o=crypto.getRandomValues.bind(crypto)}return o(s)}();if(i.length<16)throw Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=i[e];return t}return function(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}(i)}}},e=>{var t=t=>e(e.s=t);e.O(0,[473,261,47,587,315,358],()=>t(4876)),_N_E=e.O()}]);